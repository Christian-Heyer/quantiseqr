---
title: >
  Using quantiseqr
author:
- name: Federico Marini^[marinif@uni-mainz.de]
  affiliation: Institute of Medical Biostatistics, Epidemiology and Informatics ([IMBEI, Mainz](https://www.unimedizin-mainz.de/imbei/imbei/welcome-page.html?L=1))
- name: Francesce Finotello^[francesca.finotello@i-med.ac.at]
  affiliation: Institute of Bioinformatics, Biocenter Medical University of Innsbruck (https://icbi.i-med.ac.at/index.html)
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
    theme: lumen
bibliography: references_quantiseqr.bib
vignette: >
  %\VignetteIndexEntry{Using quantiseqr}
  %\VignettePackage{quantiseqr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type="text/css">
.smaller {
  font-size: 10px
}
</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  # eval = FALSE,
  comment = "#>"
)
```

# Introduction {#introduction}

This vignette describes how to use the `r BiocStyle::Biocpkg("quantiseqr")` package for ... .

TODO

# Getting started {#gettingstarted}

To install this package, start R and enter:

```{r install, eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")

BiocManager::install("quantiseqr")
```

Once installed, the package can be loaded and attached to your current workspace as follows:

```{r loadlib, eval = TRUE}
library("quantiseqr")
```

TODO

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(tibble)
```



# Some use cases for `quantiseqr`

In this section, we illustrate the usage of `quantiseqr` on a variety of datasets.
These differ with respect to their size and samples of origin, and we illustrate how the different parameters of `quantiseqr` should be set in the different scenarios.

The fundamental input for `quantiseqr` is a gene expression matrix-like object, with features on the rows, and samples as the columns.
`quantiseqr` can also directly handle `SummarizedExperiment` objects, as well as `ExpressionSet` objects, commonly used for microarray data.
In case a `SummarizedExperiment` object is passed, the quantifications of the immune contexture can be directly returned extending the `colData` of the provided input.

## Racle

`quantiseqr` ships with an example dataset with samples from four patients with metastatic melanoma published in [@EPIC2017]. 

It is available from `immunedeconv::dataset_racle`. It contains a gene expression matrix (`dataset_racle$expr_mat`) generated using bulk RNA-seq and 'gold standard' estimates of immune cell contents profiled with FACS (`dataset_racle$ref`). We are going to use the bulk RNA-seq data to run the deconvolution methods and will compare the results to the FACS data later on.   

The gene expression data is a matrix with HGNC symbols in rows and samples in columns:
The dataset is a matrix 

```{r}
# show the first 5 lines of the gene expression matrix
knitr::kable(dataset_racle$expr_mat[1:5, ])
```


TODO

```{r}
data("dataset_racle")
dim(dataset_racle$expr_mat)
```

The quantification of the immunce cell types with `quantiseqr` can be done as in the chunk below:

```{r, message=FALSE, warning=FALSE}
ti_racle <- quantiseqr::run_quantiseq(
  expression_data = dataset_racle$expr_mat,
  signature_matrix = "TIL10",
  is_arraydata = FALSE,
  is_tumordata = TRUE,
  scale_mRNA = TRUE
)
```

TODO comment on why the parameters have been picked like this

The output of `quantiseqr` can be further processed and represented in a tabular or visual manner to facilitate the comparisons across samples/conditions.

The scores returned by `quantiseqr` can be interpreted as a cell-type fraction, making it possible to represent them as a stacked bar chart.

```{r, fig.height=4, fig.width=8}
quantiplot(ti_racle)
```



We observe that

TODO: order might not be kept consistent

* the first two samples (LAU355, LAU1314) appear to contain a large amount of CD4+ T cells and B cells
* the last two samples (LAU1255, LAU125) appear to contain a large amount of "uncharacterized cells"
* the last sample (LAU125) appears to contain no CD8+ T cells, often associated with bad prognosis. 

Estimating the amount of "uncharacterized cells" is a novel feature introduced by quanTIseq and EPIC [@quantiseq2019, @EPIC2017]. 
This estimate often corresponds to the fraction of tumor cells in the sample. 

TODO: compare with facs internal refs?

## Plattner et al analysis, example 1

Lorem ipsum description of the use case...

TODO

```{}
# wget -c ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE107nnn/GSE107572/suppl/GSE107572%5Ftpm%5FPBMC%5FRNAseq%2Etxt%2Egz
# unzip GSE107572_tpm_PBMC_RNAseq.txt.gz
# read.table("GSE107572_tpm_PBMC_RNAseq.txt", header = TRUE)
```

```{r}
library(GEOquery)

# downloading the supplemental files on the fly
tpminfo_GSE107572 <- getGEOSuppFiles("GSE107572", baseDir = tempdir())
tpm_location <- rownames(tpminfo_GSE107572)[2]
tpm_location
tpmdata <-read.table(tpm_location, header = TRUE)

GEOid <- "GSE107572"
gds <- getGEO(GEOid)
GEOinfo <- pData(gds[[1]])
FACSdata <- data.frame(
  B.cells = GEOinfo$`b cells:ch1`,
  T.cells.CD4 = GEOinfo$`cd4+ t cells:ch1`,
  T.cells.CD8 = GEOinfo$`cd8+ t cells:ch1`,
  Monocytes = GEOinfo$`monocytes:ch1`,
  Dendritic.cells = GEOinfo$`myeloid dendritic cells:ch1`,
  NK.cells = GEOinfo$`natural killer cells:ch1`,
  Neutrophils = GEOinfo$`neutrophils:ch1`,
  Tregs = GEOinfo$`tregs:ch1`
)
rownames(FACSdata) <- gsub("Blood-derived immune-cell mixture from donor ", "pbmc", GEOinfo$title) # Load deconvolution data obtained by running quanTIseq (--pipelinestart=decon)

tpm_genesymbols <- tpmdata$GENE
tpmdata <- as.matrix(tpmdata[, -1])
rownames(tpmdata) <- tpm_genesymbols

ti_quant <- quantiseqr::run_quantiseq(
  expression_data = tpmdata,
  signature_matrix = "TIL10",
  is_arraydata = FALSE,
  is_tumordata = FALSE,
  scale_mRNA = TRUE
)

ti_quant

DCdata <- ti_quant


# DCdata<-read.table(paste0(dir,”/GSE107572_cell_fractions.txt"), header=TRUE, sep="\t", row.names=1)

rownames(DCdata) <- gsub("_.*$", "", sub("_", "", rownames(DCdata)))

ccells <- intersect(colnames(DCdata), colnames(FACSdata))
csbjs <- intersect(rownames(DCdata), rownames(FACSdata))

DCdata <- DCdata[csbjs, ccells]
FACSdata <- FACSdata[csbjs, ccells] # Compare cell fractions for single cell types and all cell types together
palette <- c("#451C87", "#b3b300", "#CE0648", "#2363C5", "#AB4CA1", "#0A839B", "#DD8C24", "#ED6D42")

names(palette) <- c("T.cells.CD4", "Dendritic.cells", "Monocytes", "T.cells.CD8", "Tregs", "B.cells", "NK.cells", "Neutrophils")
```


```{r fig.width=9, fig.height=9}
par(mfrow = c(3, 3))
colall <- c()
for (i in 1:(ncol(DCdata) + 1)) {
  if (i <= ncol(DCdata)) {
    x <- as.numeric(as.character(FACSdata[, i]))
    y <- DCdata[, i]
    ccell <- colnames(DCdata)[i]
    col <- palette[ccell]
  } else {
    x <- as.numeric(as.vector(as.matrix(FACSdata)))
    y <- as.vector(as.matrix(DCdata))
    ccell <- "All cells"
    col <- colall
  }
  res.cor <- cor.test(y, x)
  R <- round(res.cor$estimate, digits = 2)
  p <- format.pval(res.cor$p.value, digits = 2)
  RMSE <- round(sqrt(mean((y - x)^2, na.rm = TRUE)), digits = 2)

  regl <- lm(y ~ x)
  ymax <- max(round(max(y), digits = 2) * 1.3, 0.01)
  xmax <- max(round(max(x), digits = 2), 0.01)
  plot(x, y,
    main = gsub("(\\.)", " ", ccell), pch = 19,
    xlab = "Flow cytometry cell fractions",
    ylab = "quanTIseq cell fractions",
    col = col, cex.main = 1.3, ylim = c(0, ymax), xlim = c(0, xmax), las = 1
  )
  abline(regl)
  text(0, ymax * 0.98, cex = 1, paste0("r = ", R, ", p = ", p), pos = 4)
  text(0, ymax * 0.9, cex = 1, paste0("RMSE = ", RMSE), pos = 4)

  colall <- c(colall, rep(col, length(x)))
}
```


# Plattner et al, example 2

Lorem ipsum description of the use case...

TODO

```{r}
tpmdata <- read.table(
  system.file("extdata", "tpm_GSE75299.txt.gz", package = "quantiseqr"), header = TRUE)

tpm_genesymbols <- tpmdata$GENE
tpmdata <- as.matrix(tpmdata[, -1])
rownames(tpmdata) <- tpm_genesymbols

ti_quant <- quantiseqr::run_quantiseq(
  expression_data = tpmdata,
  signature_matrix = "TIL10",
  is_arraydata = FALSE,
  is_tumordata = TRUE,
  scale_mRNA = TRUE
)

dim(ti_quant)
rownames(ti_quant)
colnames(ti_quant)
```


```{r fig.height=7, fig.width=7}
# download.file(
#   url = paste0("http://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?save=efetch&db=sra&rettype=runinfo&term=",
#                "SRP066571"),
#   destfile = "SRP066571runtable.txt",quiet = TRUE)

library(GEOquery)
library(ggplot2)
library(reshape2)

### Load file with estimated cell fractions by quanTIseq:
cdata <- # read.csv(paste0(path, "/SRP066571_cell_fractions.txt"), header = TRUE, sep = "\t", stringsAsFactors = FALSE, row.names = 1)
  ti_quant


### Annotation
gds <- getGEO("GSE75299")
pdata <- pData(gds[[1]])

sraInfo <- read.csv(
  system.file("extdata", "SRP066571runtable.txt", package = "quantiseqr"), 
  header = TRUE, sep = ",", stringsAsFactors = FALSE)

cdata <- cbind(cdata, sraInfo[, "SampleName"][match(rownames
(cdata), sraInfo$Run)])

colnames(cdata)[length(cdata)] <- "geo_accession"
dim(pdata)
pdata <- pdata[grep("^Pt", pdata[, 1]), ]

pt_matchedinfo <- pdata[, "title"][match(cdata$geo_accession, pdata$geo_accession)]
cdata$pt_info <- pt_matchedinfo
# rownames(cdata) <- cdata[, length(cdata)]

cdata$groups <- "POST"
cdata$groups[grep("baseline", cdata$pt_info)] <- "PRE"

class(cdata)

cdata

library(tidyr)
cellfracs <- pivot_longer(cdata, cols = B.cells:Other)

cellfracs$name <- factor(cellfracs$name,
                         levels = c("B.cells", "Macrophages.M1", "Macrophages.M2",
                                    "Monocytes", "Neutrophils", "NK.cells",   
                                    "T.cells.CD4", "T.cells.CD8", "Tregs", 
                                    "Dendritic.cells", "Other"))

ggplot(cellfracs, aes(fill = name, y = value, x = Sample)) + 
  geom_bar(position = "fill", stat = "identity") + 
  scale_fill_brewer(palette = "PuOr") + 
  # viridis::scale_fill_viridis(discrete = TRUE) +
  xlab("") + 
  ylab("Cell Fractions") + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust=1))


prepost_data <- cdata[!is.na(cdata$pt_info),]
prepost_data <- prepost_data[-grep("Other", colnames(prepost_data))]

### Remove other cells and the last two columns

# cdata <- cdata[, -grep("Other", colnames(cdata))]

# cdata <- cdata[, -grep("geo_accession", colnames(cdata))]

prepost_data <- pivot_longer(prepost_data, cols = B.cells:Dendritic.cells)

prepost_data$groups <- factor(prepost_data$groups, levels = c("PRE", "POST"))

prepost_data$name <- factor(prepost_data$name,
                            levels = c("B.cells", "Macrophages.M1", "Macrophages.M2",
                                       "Monocytes", "Neutrophils", "NK.cells",   
                                       "T.cells.CD4", "T.cells.CD8", "Tregs", 
                                       "Dendritic.cells"))

ggplot(prepost_data, aes(name, value, fill = groups)) +
  geom_boxplot() +
  xlab("") + 
  ylab("cell fractions") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust=1)) 
# +
#   stat_compare_means(aes(group = groups),
#     symnum.args = list(cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1), symbols = c("****", "***", "**", "*", "ns")),
#     label = "p.signif",
#     hide.ns = TRUE, cex = 10
#   ) # default: Wilcoxon Test
```


# Running on simulated data for validation

We will now display the performance of `quantiseqr` on a dataset for which the ground truth parameters are known.  
The large simulated dataset represents the RNA-seq expression data from breast tumors with different immune-infiltration scenarios, consisting of a total of 1700 samples, that were generated by mixing RNA-seq reads from purified immune cell types and from a MCF7 breast tumor cell line.

These samples were generated considering different immune relative cell proportions, tumor purity values (0:10:100%), and at different sequencing depths (1, 2, 5, 10, 20, 50, and 100 million read pairs).

Please refer to https://icbi.i-med.ac.at/software/quantiseq/doc/ and to [@quantiseq2019] for more details.

This dataset is coupled with a table where the original information on the used true fractions is available, and can be used to benchmark the performance of the deconvolution algorithm.

```{r eval = FALSE}
# downloading first the file from https://icbi.i-med.ac.at/software/quantiseq/doc/downloads/quanTIseq_SimRNAseq_mixture.txt

# https://icbi.i-med.ac.at/software/quantiseq/doc/

tpmdata <- readr::read_tsv("quanTIseq_SimRNAseq_mixture.txt.gz")
dim(tpmdata)

# extracting the gene names, restructuring the matrix by dropping the column
tpm_genesymbols <- tpmdata$Gene
tpmdata <- as.matrix(tpmdata[, -1])
rownames(tpmdata) <- tpm_genesymbols

# running quantiseq on that set
# True mRNA fractions were simulated with no total-mRNA bias. Thus, these data should be analyzed specifying the option scale_mRNA set to FALSE
ti_quant_sim1700mixtures <- quantiseqr::run_quantiseq(
  expression_data = tpmdata,
  signature_matrix = "TIL10",
  is_arraydata = FALSE,
  is_tumordata = TRUE,
  scale_mRNA = FALSE
)

# save(ti_quant_sim1700mixtures, file = "data/ti_quant_sim1700mixtures.RData")
```

To avoid the download of a large file, we provide the precomputed object `ti_quant_sim1700mixtures` in the `quantiseqr` package - the chunk above is still fully functional once the mixture file has been retrieved.

```{r}
data(ti_quant_sim1700mixtures)
dim(ti_quant_sim1700mixtures)
head(ti_quant_sim1700mixtures)
```

We also read in the true proportions, known by design - this is provided as a text file inside `quantiseqr`.

```{r}
true_prop_1700mix <- read.table(
  system.file("extdata", "quanTIseq_SimRNAseq_read_fractions.txt.gz", package = "quantiseqr"), 
  sep = "\t", header = TRUE)
head(true_prop_1700mix)
```

In the following chunk we perform some preprocessing steps to facilitate the comparison, also in a graphical manner.

```{r fig.width=7}
# merging the two sets to facilitate the visualization
# colnames(ti_quant_sim1700mixtures) <- paste0("quantiseq_", colnames(ti_quant_sim1700mixtures))
# colnames(true_prop_1700mix) <- paste0("trueprops_", colnames(true_prop_1700mix))

# ti_quant_sim1700mixtures$method <- "quanTIseq"
# true_prop_1700mix$method <- "ground_truth"

colnames(true_prop_1700mix)[1] <- "Sample"
colnames(true_prop_1700mix)[12] <- "Other"

library("tidyr")
ti_long <- pivot_longer(ti_quant_sim1700mixtures, cols = B.cells:Other, 
                        names_to = "cell_type",
                        values_to = "value_quantiseq")
ti_long$mix_id <- paste(ti_long$Sample, ti_long$cell_type, sep = "_")

tp_long <- pivot_longer(true_prop_1700mix, cols = B.cells:Other, 
                        names_to = "cell_type",
                        values_to = "value_trueprop")
tp_long$mix_id <- paste(tp_long$Sample, tp_long$cell_type, sep = "_")


ti_tp_merged <- merge(ti_long, tp_long, by = "mix_id")
ti_tp_merged$cell_type.x <- factor(ti_tp_merged$cell_type.x, levels = colnames(true_prop_1700mix)[2:12])

# ti_merged <- rbind(ti_quant_sim1700mixtures,
                   # true_prop_1700mix)

# ti_merged_long <- pivot_longer(ti_quant_sim1700mixtures, cols = B.cells:Other)

library("ggplot2")

ggplot(ti_tp_merged,
     aes(x = value_trueprop, 
         y = value_quantiseq,
         col = cell_type.x)) + geom_point(alpha = 0.5) + theme_bw()

ggplot(ti_tp_merged,
     aes(x = value_trueprop, 
         y = value_quantiseq,
         col = cell_type.x)) + 
  facet_wrap(~cell_type.x, scales = "free") + 
  geom_point(alpha = 0.5) + theme_bw()

# for (i in colnames(ti_quant_sim1700mixtures)) {
#   message(i)
#   if(i!="Sample")
#     plot(true_prop_1700mix[[i]], ti_quant_sim1700mixtures[[i]], main = i)
# }
# plot( true_prop_1700mix$Tumor, ti_quant_sim1700mixtures$Other, main = "other")

```

This figure aims to replicate with live code the one available as [Supplementary Figure 1](https://static-content.springer.com/esm/art%3A10.1186%2Fs13073-019-0638-6/MediaObjects/13073_2019_638_MOESM2_ESM.pdf).

# Blood validation data from microarrays

GSE20300

TODO

```{r}
data("GSE20300_mixture")
dim(GSE20300_mixture)

# running quantiseq on that set
# True mRNA fractions were simulated with no total-mRNA bias. Thus, these data should be analyzed specifying the option scale_mRNA set to FALSE
ti_quant_blood_marray <- quantiseqr::run_quantiseq(
  expression_data = GSE20300_mixture,
  signature_matrix = "TIL10",
  is_arraydata = TRUE,
  is_tumordata = FALSE,
  scale_mRNA = TRUE
)

head(ti_quant_blood_marray)

data("GSE20300_gtruth")
head(GSE20300_gtruth)

plot(as.data.frame(GSE20300_gtruth)$Neutrophils, ti_quant_blood_marray$Neutrophils)
plot(as.data.frame(GSE20300_gtruth)$Monocytes, ti_quant_blood_marray$Monocytes)
plot(as.data.frame(GSE20300_gtruth)$Lymphocytes, 
     (ti_quant_blood_marray$T.cells.CD4 + 
        ti_quant_blood_marray$T.cells.CD8 + 
        ti_quant_blood_marray$Tregs + 
        ti_quant_blood_marray$B.cells +
        ti_quant_blood_marray$NK.cells)) # TODO: please review this one Francesca?
```


# Melanoma dataset

TODO

```{r eval=FALSE}
load("/Users/fede/Dropbox/quanTIseq_batch2/Vanderbilt_melanoma_confidential.RData")
ti_quant_melanoma <- quantiseqr::run_quantiseq(
  expression_data = RNAseq_tpm,
  signature_matrix = "TIL10",
  is_arraydata = FALSE,
  is_tumordata = TRUE,
  scale_mRNA = TRUE
)

density_df <- data.frame(celldens = image_totcell_dens, Sample = names(image_totcell_dens))

cd4_df <- data.frame(cd4dens = image_CD4_dens, Sample = names(image_CD4_dens))
cd8_df <- data.frame(cd8dens = image_CD8_dens, Sample = names(image_CD8_dens))
treg_df <- data.frame(tregdens = image_Treg_dens, Sample = names(image_Treg_dens))

merged_cd4 <- dplyr::inner_join(
  dplyr::inner_join(ti_quant_melanoma, cd4_df),
  density_df)
merged_cd8 <- dplyr::inner_join(
  dplyr::inner_join(ti_quant_melanoma, cd8_df),
  density_df)
merged_tregs <- dplyr::inner_join(
  dplyr::inner_join(ti_quant_melanoma, treg_df),
  density_df)

par(mfrow = c(1,3))
plot(merged_cd4$cd4dens, merged_cd4$celldens * (merged_cd4$T.cells.CD4 + merged_cd4$Tregs))
plot(merged_cd8$cd8dens, merged_cd8$celldens * merged_cd8$T.cells.CD8)
plot(merged_tregs$tregdens, merged_tregs$celldens * merged_tregs$Tregs)

plot(merged_cd4$cd4dens,(merged_cd4$T.cells.CD4 + merged_cd4$Tregs))
plot(merged_cd8$cd8dens, merged_cd8$T.cells.CD8)
plot(merged_tregs$tregdens, merged_tregs$Tregs)
```



...

# Additional Information {#additionalinfo}

e.g. using quantiseqr via immunedeconv
...

# FAQs {#faqs}

**Q: MyQ?**

A: MyA

TODO TODO
TODO TODO

Examples: can I use it with data not from human?
What about other methods to compare it against? Shoutout to `immunedeconv`

# Session Info {- .smaller}

```{r sessioninfo}
sessionInfo()
```



# References {-}
